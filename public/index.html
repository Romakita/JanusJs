<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../dist/JanusJs.js"></script>
</head>
<body>

    <video controls autoplay width='300' height='300' id='remotevideo'></video>

<script>

const janus='wss://janus.conf.meetecho.com/ws';
        const onemandev="wss://unified-janus.onemandev.tech/websocket"
        const master="wss://master-janus.onemandev.tech/websocket"
        const transport = new WebSocketJanusTransport(master);
        const a = new JanusJs(transport)
        const peerConnection = new RTCPeerConnection({iceServers: [{urls: 'stun:stun1.l.google.com:19302'}]})
        let tracks;
        let session;
        let myId;
        const pc2=new RTCPeerConnection({iceServers: [{urls: 'stun:stun1.l.google.com:19302'}]})
        const mediaStream=new MediaStream();
        const remoteVideo=document.getElementById('remotevideo');
        remoteVideo.srcObject=mediaStream;
        pc2.ontrack=(evt)=>{
            console.error('got remote track')
            console.log(evt.track);
            mediaStream.addTrack(evt.track)
        
        }


    async function attachTracks(feed,data){
        const plugin = await session.attach('janus.plugin.videoroom');
        if (plugin) {
            const register = {
                    request: "join",
                    room: 1234,
                    ptype:'subscriber',
                    // feed:feed,
                    streams : [{feed:feed}]
                }
                await plugin.send(register);
                plugin.onMessage=async (msg,jsep)=>{
                    console.log('subscriber')
                    console.warn(msg);
                    let data;
                    if(msg['plugindata']&&msg['plugindata']['data']){
                        data=msg['plugindata']['data'];
                        if(data['videoroom']==='attached'){
                            await pc2.setRemoteDescription(jsep);
                            const answer=await pc2.createAnswer()
                            await pc2.setLocalDescription(answer);
                            plugin.send({request:'start'},answer);
                        }

                    }
                    if(jsep){
                        console.error(jsep)
                    }
                }





        }

    }



    async function test() {
         session = await a.createSession()
        console.debug(session.sessionId);
        const plugin = await session.attach('janus.plugin.videoroom');
        if (plugin) {
                const displayStream = await navigator.mediaDevices.getDisplayMedia({video: true, audio: true});

                displayStream.getTracks().forEach((track) => {
                    peerConnection.addTrack(track, displayStream);
                });

                console.log(displayStream);
                const register = {
                    "request": "join",
                    "ptype": "publisher",
                    "room": 1234,
                    "display": "Shivansh"
                };
                const publish = {
                    "request": "configure",
                    "bitrate": 2000000,
                }
                peerConnection.onicecandidate = async (candidate) => {
                    if (candidate.candidate) {
                        const trickle = {janus: 'trickle', candidate: candidate.candidate.toJSON()}
                    
                        await plugin.send(trickle)
                    }

                }
                console.log(await plugin.send(register))
                plugin.onMessage = async (data, jsep) => {
                    console.warn(data);
                    if (jsep) {
                        await peerConnection.setRemoteDescription({...jsep})
                    }
                    if (data && data['plugindata'] && data['plugindata'].hasOwnProperty('data')) {
                        const dat = data['plugindata']['data'];
                        // console.log(dat);
                        if (dat['publishers']) {
                            console.warn(dat['publishers'])
                            let publishers=[];
                            publishers=dat['publishers'];
                            publishers.forEach((publisher)=>{
                                attachTracks(publisher.id,publisher)
                            });
                    
                        

                        }
                        if (dat['videoroom'] === 'joined') {

                            myId=dat['id']
                            let audioTransreciever,videoTransreciever;
                            const offer = await peerConnection.createOffer();
                            await peerConnection.setLocalDescription(offer);
                            await plugin.send(publish, offer)
                            console.log();
                        

                        }
                    }

                }
                peerConnection.ontrack=(track)=>{
                    console.log(track);
                }

            console.log(plugin.handleId);

        }


    }

    test()


</script>
</body>
</html>